#!/usr/bin/env bash
set +e

echo "=== SciERC safe runner ==="
if git rev-parse --show-toplevel >/dev/null 2>&1; then ROOT="$(git rev-parse --show-toplevel)"; else ROOT="$PWD"; fi
cd "$ROOT" || { echo "âŒ cd failed: $ROOT"; echo "OK (no-op)"; exit 0; }

GOLD_DIR="${GOLD_FORCE_DIR_SCIERC:-var/datasets/normalized/scierc}"
DEV="$GOLD_DIR/dev.jsonl"
TST="$GOLD_DIR/test.jsonl"

if [ ! -s "$DEV" ] || [ ! -s "$TST" ]; then
  echo "(!) SciERC gold missing."
  echo "Place char-offset gold at:"
  echo "  - var/datasets/normalized/scierc/dev.jsonl"
  echo "  - var/datasets/normalized/scierc/test.jsonl"
  echo "OR set: export GOLD_FORCE_DIR_SCIERC=/abs/path/with/dev_and_test_jsonl"
  echo "Then re-run: bash OP_SCIERC_RUN_SAFE"
  echo "OK (safe skip)"
  exit 0
fi

export TRANSFORMERS_OFFLINE=1
unset T2NKG_ADAPTER 2>/dev/null || true

STAMP="$(date +%Y%m%d-%H%M%S)"
RUN="var/receipts/phase7a/text2nkg_fullrun/$STAMP"
mkdir -p "$RUN"

for sp in dev test; do
  OUT="$RUN/scierc_${sp}"
  mkdir -p "$OUT"
  python tools/text2nkg/run_eval_scored.py --dataset scierc --split "$sp" --outdir "$OUT" || echo "(!) runner rc!=0 for $sp"
done

echo "OUT_ROOT=$RUN"
echo "OK (SciERC safe run)"
