#!/usr/bin/env bash
set +e

echo "=== SciERC safe runner ==="
if git rev-parse --show-toplevel >/dev/null 2>&1; then ROOT="$(git rev-parse --show-toplevel)"; else ROOT="$PWD"; fi
cd "$ROOT" || { echo "‚ùå cd failed: $ROOT"; echo "OK (no-op)"; exit 0; }

GOLD_DIR="${GOLD_FORCE_DIR_SCIERC:-var/datasets/normalized/scierc}"
DEV="$GOLD_DIR/dev.jsonl"
TST="$GOLD_DIR/test.jsonl"

if [ ! -s "$DEV" ] || [ ! -s "$TST" ]; then
  echo "(!) SciERC gold missing."
  echo "Place dev/test JSONL under: $GOLD_DIR"
  echo "Or set GOLD_FORCE_DIR_SCIERC=/abs/path"
  echo "OK (no-op)"
  exit 0
fi

STAMP="$(date +%Y%m%d-%H%M%S)"
RUN="var/receipts/phase7a/text2nkg_fullrun/$STAMP"
mkdir -p "$RUN/scierc_dev" "$RUN/scierc_test"

python tools/text2nkg/run_eval_scored.py --dataset scierc --split dev  --outdir "$RUN/scierc_dev"  || true
python tools/text2nkg/run_eval_scored.py --dataset scierc --split test --outdir "$RUN/scierc_test" || true

echo "OK"
